<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fortune Hands</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<style>
    header {
      position: relative;
      text-align: center;
      align-items: center;
      display: grid;
      justify-items: center;
      flex: 0 0 20%;
      padding-top: 15%;
    }
    
    .circular-frame-game {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);

    width: 80%;
    height: 80%;
    max-width: 80vmin;
    max-height: 80vmin;

    background: url('static/assets/circulargamenohand.png') no-repeat center center;
    background-size: contain;

    display: flex;
    justify-content: center;
    align-items: center;

    z-index: 5;
    overflow: visible;
    }
    .cpu-anim {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      z-index: 1;
    }
    .cpu-cloud {
      position: absolute;
      z-index: 2;
      pointer-events: none;
      transform: scale(0.4);
    }
    .cpu-cloud-top-right {
      top: 0%;
      right: -35%;
      width: 100%;
    }
    .cpu-cloud-bottom-left {
      bottom: 8%;
      left: -38%;
      width: 100%;
    }


    .round-image {
      width: 100%;
      height: auto;
    }
    .won-counter {
      width: 100%;
      height: auto;
    }
    .user-preview-container {
    position: absolute;
    bottom: 15px;   /* Lebih dekat ke sudut */
    right: 15px;    /* Lebih dekat ke sudut */
    width: 30%;   /* Ukuran lebih kecil */
    height: 23%;  /* Ukuran lebih kecil */
    }
    .user-frame {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    .video-feed {
      position: absolute;
      top: 12px;    /* Sesuaikan posisi agar pas di dalam frame */
      left: 12px;   /* Sesuaikan posisi agar pas di dalam frame */
      width: 90%; /* Sesuaikan ukuran agar pas di dalam frame */
      height: 95%;/* Sesuaikan ukuran agar pas di dalam frame */
      border-radius: 150px 150px 0px 0px;
      border: 3px solid #fff;
      outline: 2px solid #fff;
      outline-offset: 4px;
      z-index: 1;
    }
    /* Prompt Overlay Images */
    .prompt-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    transition: opacity 0s ease;
    }

    .prompt-image {
    max-width: 100%;
    height: auto;
    display: block;
    animation: fadeIn 1s ease;
    }

    .prompt-image.be-ready {
    animation: pulse 2s infinite;
    }

    @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
    }

    /* COUNTDOWN OVERLAY */
    .countdown-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 200;
    pointer-events: none;
    }

    .countdown-img {
    max-width: 100%;
    height: auto;
    animation: scalePop 0.8s ease;
    }

    @keyframes scalePop {
    0% {
        transform: scale(0.5);
        opacity: 0;
    }
    60% {
        transform: scale(1.1);
        opacity: 1;
    }
    100% {
        transform: scale(1);
    }
    }

    /* RESULT OVERLAY */
    .result-overlayy {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }

    .result-imagee {
      max-width: 50%;
      height: auto;
      animation: scalePop 0.8s ease;
    }
    .result-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }

    .result-image {
      max-width: 100%;
      height: auto;
      animation: scalePop 0.8s ease;
    }

    .round-overlay {
      background:
        linear-gradient(
          rgba(0, 0, 0, 0.45),
          rgba(0, 0, 0, 0.45)
        ),
        url("{{ url_for('static', filename='assets/bg.png') }}") no-repeat center center;

      background-size: cover;
    }

    .round-anim-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    #roundAnim {
      width: 100%;
      height: auto;
      display: block;
      z-index: 1;
    }

    .cloud {
      position: absolute;
      z-index: 3;
      pointer-events: none;
      transform: scale(0.4);
    }

    .cloud-top-right {
      top: -3%;
      right: -45%;
      width: 100%;
    }

    .cloud-bottom-left {
      bottom: 10%;
      left: -38%;
      width: 100%;
    }
</style>
<body>
  <div class="container">
    <header>
      <img src="{{ url_for('static', filename='assets/round' ~ round ~ round ~ '.png') }}" alt="Round {{ round }}" class="round-image" id="roundImage">
      <img src="{{ url_for('static', filename='assets/won' ~ wins ~ '-3.png') }}" alt="Won {{ wins }}/3" class="won-counter" id="wonCounter">
    </header>
    
    <main>
    </main>
    
    <footer>
      <div class="user-preview-container">
        <img src="{{ url_for('video_feed') }}" class="video-feed" id="videoFeed">
      </div>
    </footer>
    
    <div class="circular-frame-game">
        <img
          src="{{ url_for('static', filename='assets/cloud-top.png') }}"
          class="cpu-cloud cpu-cloud-top-right"
          alt="Cloud Top"
        >
        <img
          src="{{ url_for('static', filename='assets/cloud-bottom.png') }}"
          class="cpu-cloud cpu-cloud-bottom-left"
          alt="Cloud Bottom"
        >
        <img id="cpuAnim" class="cpu-anim" alt="">
      </div>
  </div>
    <div class="prompt-overlay">
        
        <img src="{{ url_for('static', filename='assets/show-hand.png') }}" alt="Show hand to camera" class="prompt-image" id="showHandPrompt">
        <img src="{{ url_for('static', filename='assets/be-ready.png') }}" alt="Be ready" class="prompt-image be-ready" id="beReadyPrompt" style="display:none;">
    </div>
    <!-- Tambahkan DI MANA SAJA di dalam body (bisa di luar container) -->
    <div id="hand-overlay" 
        style="display:none; 
                position:absolute; 
                width:50px; 
                height:50px; 
                background:rgba(255,215,0,0.5); 
                border-radius:50%; 
                transform:translate(-50%,-50%); 
                z-index:20;">
    </div>

    <!-- COUNTDOWN OVERLAY (TANPA BACKGROUND GELAP) -->
    <div class="countdown-overlay" id="countdownOverlay" style="display:none;">
        <img src="{{ url_for('static', filename='assets/countdown1.png') }}" class="countdown-img" id="count3">
        <img src="{{ url_for('static', filename='assets/countdown2.png') }}" class="countdown-img" id="count2" style="display:none;">
        <img src="{{ url_for('static', filename='assets/countdown3.png') }}" class="countdown-img" id="count1" style="display:none;">
    </div>

    <div class="result-overlay" id="resultOverlay" style="display:none;">
      <img id="resultImage" class="result-image">
    </div>
    
    <div class="result-overlayy" id="failOverlay" style="display:none;">
      <img src="{{ url_for('static', filename='assets/Pop up.png') }}" 
          class="result-imagee">
    </div>

    <!-- ROUND OVERLAY (gabungan round.html) -->
    <div class="result-overlay round-overlay" id="roundOverlay" style="display:flex;">
      <div class="round-anim-wrapper">
        <img id="roundAnim" alt="Round {{ round }}">
        <img
          src="{{ url_for('static', filename='assets/cloud-top.png') }}"
          class="cloud cloud-top-right"
          alt="Cloud Top"
        >
        <img
          src="{{ url_for('static', filename='assets/cloud-bottom.png') }}"
          class="cloud cloud-bottom-left"
          alt="Cloud Bottom"
        >
      </div>
    </div>



  <script src="{{ url_for('static', filename='js/audio-bridge.js') }}"></script>
  <script>
    function navigate(path) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'nav', url: path }, '*');
      } else {
        window.location.href = path;
      }
    }

    let promptChanged = false;
    let gameStarted = false;
    let userGesture = null;
    let handDetectionAttempts = 0;
    const MAX_DETECTION_ATTEMPTS = 3;
    let cameraReady = false;
    let currentRound = {{ round | default(1) }};
    const totalFrames = 60;
    const frameRate = 24;
    let currentFrame = 0;
    let roundAnimInterval = null;
    const roundAnimImg = document.getElementById('roundAnim');

    const videoImg = document.getElementById('videoFeed');
    const cpuFrame = document.querySelector('.circular-frame-game');
    const cpuAnimImg = document.getElementById('cpuAnim');
    const RPS_TOTAL_FRAMES = 150;
    const RPS_FRAME_RATE = 30;
    let cpuAnimInterval = null;

    videoImg.onload = () => {
        if (!cameraReady) {
            cameraReady = true;
            console.log('âœ… Kamera aktif & stream jalan');
        }
    };

    videoImg.onerror = () => {
        console.error('âŒ Kamera tidak bisa diakses');
        alert('Kamera tidak terdeteksi.\nPastikan kamera tidak digunakan aplikasi lain.');
    };

    // START TRACKING
    fetch('/api/start-tracking', { method: 'POST' });

    // DETECT HAND â†’ BE READY (dengan retry mechanism)
    let handDetectionInterval = null;
    function startHandDetection() {
    if (handDetectionInterval) clearInterval(handDetectionInterval);
    handDetectionInterval = setInterval(async () => {

    // ðŸš« STOP kalau kamera belum siap
    if (!cameraReady) {
        console.log('â³ Menunggu kamera siap...');
        return;
    }

    if (promptChanged) return;

    try {
        const res = await fetch('/api/hand-data');
        const data = await res.json();

        console.log('HAND DATA:', data);

        // âœ… VALIDASI LENGKAP & AMAN
        if (
            data.detected === true &&
            data.gesture !== 'none' &&
            data.gesture !== 'unknown'
        ) {
            promptChanged = true;
            clearInterval(handDetectionInterval);

            console.log('âœ‹ Tangan terdeteksi â†’ BE READY');

            // Play hand detected sound
            audioManager.play('handDetected');

            document.getElementById('showHandPrompt').style.display = 'none';
            document.getElementById('beReadyPrompt').style.display = 'block';

            setTimeout(() => {
                document.querySelector('.prompt-overlay').style.display = 'none';
                startCountdown();
            }, 1500);
        }

        } catch (error) {
            console.error('Error detecting hand:', error);
        }

    }, 200);  // Check setiap 200ms untuk respons lebih cepat
    }

    function pad(num) {
      return num.toString().padStart(5, '0');
    }

    function resetCpuFrameToNoHand() {
      if (cpuAnimInterval) {
        clearInterval(cpuAnimInterval);
        cpuAnimInterval = null;
      }
      if (cpuAnimImg) {
        cpuAnimImg.style.display = 'none';
        cpuAnimImg.removeAttribute('src');
      }
      if (cpuFrame) {
        cpuFrame.style.background = "url('static/assets/circulargamenohand.png') no-repeat center center";
        cpuFrame.style.backgroundSize = 'contain';
      }
    }

    function getRpsAnimConfig(gesture) {
      const map = {
        rock: { folder: 'Rock', prefix: 'Rock' },
        paper: { folder: 'Paper', prefix: 'Paper' },
        scissors: { folder: 'Scissor', prefix: 'Scissor' }
      };
      return map[gesture];
    }

    function getRpsFramePath(gesture, frame) {
      const cfg = getRpsAnimConfig(gesture);
      if (!cfg) return '';
      return encodeURI(`/static/assets/anim/Rock Paper Scissor/${cfg.folder}/${cfg.prefix}_${pad(frame)}.png`);
    }

    function getFramePath(frame, roundNum) {
      return `/static/assets/anim/Scroll/Scroll/Round ${roundNum}/${roundNum}_${pad(frame)}.png`;
    }

    function preloadRoundFrames(roundNum) {
      for (let i = 0; i < totalFrames; i++) {
        const preload = new Image();
        preload.src = getFramePath(i, roundNum);
      }
    }

    function playRoundAnimation(roundNum, onDone) {
      if (roundAnimInterval) clearInterval(roundAnimInterval);
      currentFrame = 0;
      roundAnimInterval = setInterval(() => {
        if (roundAnimImg) {
          roundAnimImg.src = getFramePath(currentFrame, roundNum);
        }
        currentFrame++;

        if (currentFrame >= totalFrames) {
          clearInterval(roundAnimInterval);
          roundAnimInterval = null;
          setTimeout(() => {
            if (onDone) onDone();
          }, 300);
        }
      }, 1000 / frameRate);
    }

    function updateRoundUI(nextRound, winsCount) {
      const roundHeader = document.getElementById('roundImage');
      const wonCounter = document.getElementById('wonCounter');

      if (typeof nextRound === 'number') {
        const roundSrcHeader = `static/assets/round${nextRound}${nextRound}.png`;
        if (roundHeader) roundHeader.src = roundSrcHeader;
        currentRound = nextRound;
      }

      if (typeof winsCount === 'number' && wonCounter) {
        wonCounter.src = `static/assets/won${winsCount}-3.png`;
      }
    }

    function showRoundOverlayThenDetect() {
      const roundOverlay = document.getElementById('roundOverlay');
      if (roundOverlay) roundOverlay.style.display = 'flex';
      audioManager.play('paperScroll');
      preloadRoundFrames(currentRound);
      playRoundAnimation(currentRound, () => {
        if (roundOverlay) roundOverlay.style.display = 'none';
        startHandDetection();
      });
    }

    function resetRound(nextRound, winsCount) {
      if (handDetectionInterval) clearInterval(handDetectionInterval);
      promptChanged = false;
      gameStarted = false;
      userGesture = null;

      const promptOverlay = document.querySelector('.prompt-overlay');
      const showHand = document.getElementById('showHandPrompt');
      const beReady = document.getElementById('beReadyPrompt');
      const countdown = document.getElementById('countdownOverlay');
      const resultOverlay = document.getElementById('resultOverlay');
      const failOverlay = document.getElementById('failOverlay');
      const roundOverlay = document.getElementById('roundOverlay');

      if (promptOverlay) promptOverlay.style.display = 'flex';
      if (showHand) showHand.style.display = 'block';
      if (beReady) beReady.style.display = 'none';
      if (countdown) countdown.style.display = 'none';
      if (resultOverlay) resultOverlay.style.display = 'none';
      if (failOverlay) failOverlay.style.display = 'none';
      if (roundOverlay) roundOverlay.style.display = 'none';
      resetCpuFrameToNoHand();
      updateRoundUI(nextRound, winsCount);
      showRoundOverlayThenDetect();
    }

    // Tampilkan round dulu, lalu mulai deteksi tangan
    resetCpuFrameToNoHand();
    showRoundOverlayThenDetect();

    function handleDetectionFail() {
      const overlay = document.getElementById('failOverlay');
      overlay.style.display = 'flex';

      audioManager.play('draw'); // atau sound khusus error

      // ulangi round tanpa reload
      setTimeout(() => {
        resetRound();
      }, 2500);
    }


    // COUNTDOWN
    function startCountdown() {
    const overlay = document.getElementById('countdownOverlay');
    const imgs = ['count3', 'count2', 'count1'];

    overlay.style.display = 'flex';

    // Play countdown sound

    imgs.forEach((id, i) => {
        setTimeout(() => {
        imgs.forEach(x => document.getElementById(x).style.display = 'none');
        document.getElementById(id).style.display = 'block';
        audioManager.play('countdown');
        }, i * 1200);
    });

    setTimeout(() => {
        overlay.style.display = 'none';
        lockUserGesture();
    }, 3400);
    }


    // LOCK USER GESTURE (dengan validasi lebih baik)
    async function lockUserGesture() {
      if (gameStarted) return;
      gameStarted = true;

      await new Promise(resolve => setTimeout(resolve, 300));

      const res = await fetch('/api/hand-data');
      const data = await res.json();

      if (
        !data.detected ||
        data.gesture === 'unknown' ||
        data.gesture === 'none'
      ) {
        handleDetectionFail();
        return;
      }

      userGesture = data.gesture;
      console.log('User gesture locked:', userGesture);
      startCpuTurn();
    }



    // CPU TURN
    async function startCpuTurn() {
    const choices = ['rock', 'paper', 'scissors'];
    const cpuGesture = choices[Math.floor(Math.random() * 3)];

    console.log('CPU gesture:', cpuGesture);
    await showCpuGesture(cpuGesture);
    judge(userGesture, cpuGesture);
    }


    // SHOW CPU IMAGE
    function showCpuGesture(gesture) {
      return new Promise(resolve => {
        const cfg = getRpsAnimConfig(gesture);
        if (!cfg || !cpuFrame || !cpuAnimImg) {
          resolve();
          return;
        }

        if (cpuAnimInterval) {
          clearInterval(cpuAnimInterval);
          cpuAnimInterval = null;
        }

        cpuFrame.style.background = 'none';
        cpuAnimImg.style.display = 'block';

        let frameIndex = 0;
        const totalFrames = RPS_TOTAL_FRAMES;
        const frameDuration = 1000 / RPS_FRAME_RATE;

        cpuAnimImg.src = getRpsFramePath(gesture, frameIndex);
        frameIndex++;

        cpuAnimInterval = setInterval(() => {
          if (frameIndex >= totalFrames) {
            clearInterval(cpuAnimInterval);
            cpuAnimInterval = null;
            resolve();
            return;
          }
          cpuAnimImg.src = getRpsFramePath(gesture, frameIndex);
          frameIndex++;
        }, frameDuration);
      });
    }


    // JUDGE RESULT
    function judge(user, cpu) {
    let result = 'SERI';

    if (
        (user === 'rock' && cpu === 'scissors') ||
        (user === 'scissors' && cpu === 'paper') ||
        (user === 'paper' && cpu === 'rock')
    ) {
        result = 'MENANG';
    }
    else if (user !== cpu) {
        result = 'KALAH';
    }

    console.log('Result:', result);

    setTimeout(() => {
        showResult(result);
    }, 500);
    }

    async function showResult(result) {
      const overlay = document.getElementById('resultOverlay');
      const img = document.getElementById('resultImage');

      const imgMap = {
        MENANG: 'static/assets/result-win.png',
        KALAH: 'static/assets/result-lose.png',
        SERI: 'static/assets/result-draw.png'
      };

      img.src = imgMap[result];
      overlay.style.display = 'flex';

      // Play result sound based on outcome
      if (result === 'MENANG') {
        audioManager.play('win');
      } else if (result === 'KALAH') {
        audioManager.play('lose');
      } else if (result === 'SERI') {
        audioManager.play('draw');
      }

      // Kirim hasil ke server
      try {
        const response = await fetch('/api/game-result', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ result: result })
        });

        const data = await response.json();

        setTimeout(() => {
          if (data.status === 'game_over') {
            // Game selesai (menang 3x atau kalah 3x)
            if (result === 'MENANG') {
              navigate('/win');
            } else if (result === 'KALAH') {
              navigate('/lose');
            }  // Kembali ke menu utama
          } else if (result === 'SERI') {
            // Seri, ulangi round yang sama tanpa reload
            resetRound(data.current_round, data.wins);
          } else {
            // Lanjut ke round berikutnya tanpa reload
            resetRound(data.current_round, data.wins);
          }
        }, 2500);

      } catch (error) {
        console.error('Error sending result:', error);
        // Fallback jika error
        setTimeout(() => {
          resetRound();
        }, 2500);
      }
    }

    </script>
</body>
</html>
